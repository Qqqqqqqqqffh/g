name: Benchmark Runner

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  run-benchmark:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Install dependencies
      run: sudo apt-get install -y git cmake
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y valgrind sqlite3 python3-pip curl jq
        pip install requests

    - name: Compile optimized
      run: |
        cmake . > compile_stdout.log 2> compile_stderr.log
        make >> compile_stdout.log 2>> compile_stderr.log

    - name: Run cuda-memcheck
      run: |
        cuda-memcheck ./main > cuda_memcheck.log 2>&1 || true

    - name: Run valgrind check
      run: |
        valgrind --leak-check=full --error-exitcode=1 ./main > valgrind_stdout.log 2> valgrind_stderr.log || true

    - name: Run program and capture timings
      id: run_program
      run: |
        ./main > run_stdout.log 2> run_stderr.log
        
        if [ -f "output.json" ]; then
          echo "output.json found. Parsing timings..."
          
          timings_json=$(cat output.json | jq -c '.timings')
          echo "timings=$timings_json" >> $GITHUB_OUTPUT
          
          timing_report=""
          for key in $(jq -r '.timings | keys[]' output.json); do
            value=$(jq -r ".timings.$key" output.json)
            timing_report+="$key: $value seconds\n"
          done
          
          echo "timing_report<<EOF" >> $GITHUB_OUTPUT
          echo "$timing_report" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "output.json not found. No timings to report."
          echo "timings={}" >> $GITHUB_OUTPUT
          echo "timing_report=No timings data available" >> $GITHUB_OUTPUT
        fi
        
        echo "start_time=$(date -u +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_OUTPUT

    - name: Get Telegram ID
      id: get_telegram_id
      run: |
        response=$(curl -s "https://your-yandex-server.com/get_binding?github_username=${{ github.actor }}")
        telegram_id=$(echo $response | jq -r '.telegram_id')
        
        if [ "$telegram_id" == "null" ] || [ -z "$telegram_id" ]; then
          echo "No Telegram ID found for ${{ github.actor }}"
          echo "telegram_id=0" >> $GITHUB_OUTPUT
        else
          echo "Telegram ID found: $telegram_id"
          echo "telegram_id=$telegram_id" >> $GITHUB_OUTPUT
        fi

    - name: Prepare logs archive
      if: ${{ steps.get_telegram_id.outputs.telegram_id != '0' }}
      run: |
        tar czf logs.tar.gz \
            output.json \
            compile_stdout.log \
            compile_stderr.log \
            run_stdout.log \
            run_stderr.log \
            cuda_memcheck.log \
            valgrind_stdout.log \
            valgrind_stderr.log

        echo "ðŸ•’ Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°: ${{ steps.run_program.outputs.start_time }} UTC" > description.txt
        echo "â± Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð·Ð°Ð¼ÐµÑ€Ð¾Ð²:" >> description.txt
        echo "${{ steps.run_program.outputs.timing_report }}" >> description.txt
        echo "ðŸ‘¤ GitHub: ${{ github.actor }}" >> description.txt
        echo "ðŸ“¦ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: ${{ github.repository }}" >> description.txt

    - name: Send logs to Telegram
      if: ${{ steps.get_telegram_id.outputs.telegram_id != '0' }}
      run: python3 telegram_sender.py ${{ steps.get_telegram_id.outputs.telegram_id }}
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        YANDEX_SERVER_URL: "https://your-yandex-server.com"

    - name: Save results to Yandex server
      run: python3 save_result.py
      env:
        YANDEX_SERVER_URL: "https://your-yandex-server.com"
        GITHUB_ACTOR: ${{ github.actor }}
        TIMINGS_JSON: ${{ steps.run_program.outputs.timings }}
        TIMESTAMP: ${{ steps.run_program.outputs.start_time }}

    - name: Upload logs as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-logs
        path: |
          output.json
          compile_stdout.log
          compile_stderr.log
          run_stdout.log
          run_stderr.log
          cuda_memcheck.log
          valgrind_stdout.log
          valgrind_stderr.log
